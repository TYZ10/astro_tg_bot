from aiogram import types, F
from aiogram.fsm.context import FSMContext
from aiogram.filters.state import StateFilter

from . import AllTypesGeneration
from example_bot.Tbot import BasicBotOperation
from .get_info_gpt import main_get_info_gpt
from example_bot.Config_bot import states
from example_bot.misc import create_aspects
from example_bot.misc.datetime_function import get_day_and_hours_from_date


class Predictions(BasicBotOperation):
    text = {
        "day": """Ты – эксперт по жизненным стратегиям, создающий персональные прогнозы на один день без астрологических терминов. Твоя задача – сформировать понятный, теплый и полезный прогноз, который помогает человеку осознанно прожить этот день, используя его возможности. Как ты пишешь: — Простым, человеческим языком, без сложных слов. — Без гендерных обращений – прогноз подходит как для мужчины, так и для женщины. — Без использования специальных символов (*, #, _, -, +, [, ], {, } и других). — Без разметки Markdown, HTML и Telegram-форматирования. — Текст должен быть сплошным, без элементов кода, выделений и форматирования. Использование смайликов: — Вставляй от 20 до 40 смайликов равномерно по всему тексту. — Используй разные смайлики, которые передают эмоции, но не перебарщивай с их количеством в одном абзаце. — Размещай смайлики в конце ключевых предложений, а не только в конце текста. — Не используй одни и те же смайлики подряд. — Смайлики должны быть уместны по контексту и помогать передавать настроение.

Структура прогноза:

Прогноз на [дата]

Общий настрой дня

Какие главные тенденции ощущаются в этот день – динамичный, спокойный, требующий осторожности, благоприятный для активных действий.

Какие сферы особенно важны – работа, финансы, эмоции, внутренние изменения, отношения.

Какие внутренние качества помогут сделать день максимально эффективным – гибкость, решительность, терпение, уверенность.

Персональные рекомендации

Пользователь выбирает 4 аспекта из 8 возможных.

Только по этим 4 аспектам нужно написать развернутый прогноз.

Выбранные аспекты передаются вместе с данными пользователя.

Прогноз должен содержать 3 подкатегории для каждого выбранного аспекта.

Возможные аспекты (из них пользователь выбирает 4):

Финансы и карьера, Семья и дети, Любовь и отношения, Духовный рост и саморазвитие, Здоровье и энергия, Опасности и предупреждения, Дети и воспитание, Миссия и предназначение

Структура прогноза по каждому выбранному аспекту:

1. Как этот день влияет на данный аспект? 2. Что особенно важно учитывать в течение дня? 3. Какие рекомендации помогут провести день осознанно и продуктивно?

Итог дня и ключевая рекомендация

Итог дня – одна фраза, передающая его общий смысл.

Финальный совет – что важно помнить, чтобы день прошел осознанно и эффективно.

Входные данные:

Выбранные аспекты: {}

Астрологические расчеты """,
        "month": """Ты – эксперт по жизненным стратегиям, создающий персональные прогнозы без астрологических терминов. Твоя задача – сформировать понятный, теплый и полезный прогноз на один месяц, который легко читается и помогает человеку осознанно выстроить этот период, используя его возможности.

Как ты пишешь: — Простым, человеческим языком, без сложных слов. — Без гендерных обращений – прогноз подходит как для мужчины, так и для женщины. — Без использования специальных символов (*, #, _, -, +, [, ], {, } и других). — Без разметки Markdown, HTML и Telegram-форматирования. — Текст должен быть сплошным, без элементов кода, выделений и форматирования.

Использование смайликов: — Вставляй от 30 до 40 смайликов равномерно по всему тексту. — Используй разные смайлики, которые передают эмоции, но не перебарщивай с их количеством в одном абзаце. — Размещай смайлики в конце ключевых предложений, а не только в конце текста. — Не используй одни и те же смайлики подряд. — Смайлики должны быть уместны по контексту и помогать передавать настроение.

Структура прогноза:

Прогноз на [месяц]

Общий настрой месяца Какие главные тенденции будут ощущаться – месяц активный, требующий осторожности, подходящий для размышлений или новых начинаний. Какие сферы будут особенно важны – работа, финансы, эмоции, внутренние изменения, отношения. В какие недели месяца стоит активнее двигаться вперед, а когда лучше сосредоточиться на внутренней работе. Какие качества помогут максимально эффективно использовать этот месяц – решительность, гибкость, терпение, смелость.

Персональные рекомендации Пользователь выбирает 2 аспекта из 8 возможных. Только по этим 2 аспектам нужно написать развернутый прогноз. Выбранные аспекты передаются вместе с данными пользователя. Прогноз должен содержать 4 подкатегории для каждого выбранного аспекта.

Возможные аспекты (из них пользователь выбирает 2): Финансы и карьера, Семья и дети, Любовь и отношения, Духовный рост и саморазвитие, Здоровье и энергия, Опасности и предупреждения, Дети и воспитание, Миссия и предназначение

Структура прогноза по каждому выбранному аспекту: — Какие события и изменения могут происходить в этом месяце? — Какие ключевые моменты будут особенно важны? — Когда лучше проявлять активность, а когда сохранять стабильность? — Какие рекомендации помогут лучше использовать этот месяц?

Итог месяца и ключевая рекомендация Итог месяца – одна фраза, передающая его общий смысл. Финальный совет – что важно помнить, чтобы месяц прошел осознанно, стабильно и с пользой.

Входные данные:

Выбранные аспекты: {}

Астрологические расчеты """,
        "year": """Ты – эксперт по жизненным стратегиям, создающий персональные прогнозы без астрологических терминов. Твоя задача – сформировать понятный, теплый и полезный прогноз, который легко читается и помогает человеку осознанно выстроить год, используя его возможности.

Как ты пишешь: — Простым, человеческим языком, без сложных слов. — Без гендерных обращений – прогноз подходит как для мужчины, так и для женщины. — Без использования специальных символов (*, #, _, -, +, [, ], {, } и других). — Без разметки Markdown, HTML и Telegram-форматирования. — Текст должен быть сплошным, без элементов кода, выделений и форматирования.

Использование смайликов: — Вставляй от 25 до 40 смайликов равномерно по всему тексту. — Используй разные смайлики, которые передают эмоции, но не перебарщивай с их количеством в одном абзаце. — Размещай смайлики в конце ключевых предложений, а не только в конце текста. — Не используй одни и те же смайлики подряд. — Смайлики должны быть уместны по контексту и помогать передавать настроение.

Структура прогноза:

Прогноз на [номер года]

Общий настрой года Какие главные тенденции будут ощущаться – год стабильный, динамичный, требующий гибкости или сосредоточенности. Какие сферы будут особенно важны – работа, финансы, эмоции, внутренние изменения, отношения. В какие периоды года стоит активнее двигаться вперед, а в какие лучше подождать, накопить ресурсы. Какие личные качества помогут максимально эффективно использовать год – терпение, решительность, интуиция, гибкость.

Персональные рекомендации  Пользователь выбирает 2 аспекта из 8 возможных. Только по этим 2 аспектам нужно написать развернутый прогноз.  Выбранные аспекты передаются вместе с данными пользователя. Прогноз должен содержать 4 подкатегории для каждого выбранного аспекта.

Возможные аспекты (из них пользователь выбирает 2): 1 Финансы и карьера 2 Семья и дети 3 Любовь и отношения 4 Духовный рост и саморазвитие 5 Здоровье и энергия 6 Опасности и предупреждения 7 Дети и воспитание 8 Миссия и предназначение

Структура прогноза по каждому выбранному аспекту: — Какие события и изменения могут происходить в этом году? — Какие ключевые моменты будут особенно важны? — Когда лучше проявлять активность, а когда сохранять стабильность? — Какие рекомендации помогут лучше использовать этот год?

Итог года и ключевая рекомендация Итог года – одна фраза, передающая его общий смысл. Финальный совет – что важно помнить, чтобы год прошел осознанно, стабильно и с пользой.

Входные данные:

Выбранные аспекты: {}

Астрологические расчеты """
    }

    async def main_start_predictions(
            self,
            message: types.Message,
            state: FSMContext,
    ):
        await state.set_state(AllTypesGeneration()[message.text])
        await message.answer(
            text="""Звёзды готовы раскрыть тебе тайны будущего! ✨ Наш бот создаёт персональные прогнозы, чтобы ты мог осознанно планировать важные события, использовать благоприятные периоды и обходить возможные сложности. Выбери свой прогноз:

📆 Прогноз на следующий месяц — детальный анализ ближайших 30 дней: ключевые события, возможности, вызовы и периоды максимальной активности.

💼 Бизнес-гороскоп — когда лучше принимать важные решения, запускать проекты, управлять финансами и искать новые возможности.

❤️‍🩹 Астрологический прогноз для здоровья — на что обратить внимание, когда беречь себя, а когда наоборот — заряжаться энергией и действовать на полную мощность.

☀️ Ежедневные прогнозы — получай персональные предсказания на каждый день, чтобы жить в ритме со Вселенной (доступно по подписке).

💞 Анализ совместимости в отношениях — разбор глубины вашей связи, понимание сильных и сложных сторон пары, советы для гармонии и роста.

Будущее уже написано в звёздах, а теперь оно станет понятным и доступным для тебя! 🔥🌌""",
            reply_markup=self.keyboard.predictions_and_horoscopes_ikb
        )

    async def daily_forecasts(
            self,
            message: types.Message
    ):
        await message.answer(
            text="""☀️ Хочешь начинать каждый день с подсказок от звёзд? Ежедневный гороскоп составляется специально для тебя и приходит вечером в удобное время, которое ты выбираешь. Ты можешь выбрать до 4 сфер, которые для тебя наиболее важны:
💼 Финансы и карьера
👨‍👩‍👧‍👦 Семья и дети
❤️ Любовь и отношения
🌟 Духовный рост и саморазвитие
🏥 Здоровье и энергия
⚠️ Опасности и предупреждения
👶 Дети и воспитание
✨ Миссия и предназначение

Ежедневный гороскоп доступен по подписке. Ты можешь её оформить:
✨ За 2 приглашённых друзей, которые сделают хотя бы одну генерацию.
✨ Или за символическую плату всего 150 рублей — это поможет поддерживать работу бота и оплачивать необходимые сервисы.

Звёзды готовы раскрыть свои тайны! Жми кнопку и начни получать свои прогнозы каждый день. 🚀""",
            reply_markup=self.keyboard.daily_forecasts_ikb
        )

    async def selection_predictions(
            self,
            call: types.CallbackQuery,
            state: FSMContext
    ):
        await self.get_predictions(call, state)

    async def get_predictions(
            self,
            call: types.CallbackQuery,
            state: FSMContext):

        st = await state.get_data()
        period = st["period"]

        if period == "day":
            text = """☀️ Хочешь начинать каждый день с подсказок от звёзд? Ежедневный гороскоп составляется специально для тебя и приходит вечером в удобное время, которое ты выбираешь. Ты можешь выбрать до 4 сфер, которые для тебя наиболее важны:
💼 Финансы и карьера
👨‍👩‍👧‍👦 Семья и дети
❤️ Любовь и отношения
🌟 Духовный рост и саморазвитие
🏥 Здоровье и энергия
⚠️ Опасности и предупреждения
👶 Дети и воспитание
✨ Миссия и предназначение

Ежедневный гороскоп доступен по подписке. Ты можешь её оформить:
✨ За 2 приглашённых друзей, которые сделают хотя бы одну генерацию.
✨ Или за символическую плату всего 150 рублей — это поможет поддерживать работу бота и оплачивать необходимые сервисы.

Звёзды готовы раскрыть свои тайны! Жми кнопку и начни получать свои прогнозы каждый день. 🚀"""

            col_info = self.operation_db.COLUMNS_INFO

            payments_end = self.operation_db.select_user_info_db(
                col_info.payments_end,
                call.from_user.id
            )

            if get_day_and_hours_from_date(payments_end) <= 0:
                await call.message.answer(
                    text="""Ежедневный гороскоп доступен по подписке. Ты можешь её оформить:
✨ За 2 приглашённых друзей, которые сделают хотя бы одну генерацию.
✨ Или за символическую плату всего 150 рублей — это поможет поддерживать работу бота и оплачивать необходимые сервисы.
""",
                    reply_markup=self.keyboard.payments_ikb
                )
                return
        elif period == "month":
             text = """📅 Гороскоп на месяц — это краткий и точный прогноз на 30 дней. Ты узнаешь, где тебя ждёт успех, а где стоит быть внимательнее. Звёзды подскажут лучшие моменты для действий. 🌙"

Пояснение про выбор аспектов:
"Перед составлением прогноза выбери 2 аспекта, которые сейчас особенно важны:

💼 Финансы и карьера
❤️ Любовь и отношения
🏠 Семья и домашние дела
🌟 Духовный рост и саморазвитие
🏥 Здоровье и энергия
⚠️ Опасности и предупреждения
✨ Миссия и предназначение
Каждый месяц уникален, и этот прогноз поможет тебе использовать его возможности на максимум. Жми кнопку и узнавай, что тебя ждёт! 🌠"""
        else:
            text = """🗓️ Гороскоп на год — это твой личный путеводитель на целый год. Ты узнаешь, какие возможности и вызовы ждут тебя, в какие моменты стоит действовать, а когда лучше сделать паузу. Всё это — на основе твоих астрологических данных! 🌟"


Пояснение про выбор аспектов:
"Перед составлением прогноза выбери 2 аспекта, которые для тебя наиболее важны:

💼 Финансы и карьера
❤️ Любовь и отношения
🏠 Семья и домашние дела
🌟 Духовный рост и саморазвитие
🏥 Здоровье и энергия
⚠️ Опасности и предупреждения
✨ Миссия и предназначение
Твой прогноз поможет планировать важные события и оставаться в гармонии с энергиями года. Жми кнопку и готовься к 2025 году! 🚀
"""

        await call.message.answer(
            text=text,
            reply_markup=self.keyboard.get_aspect_selection_ikb
        )
        await state.set_state(states.predictions_1_aspect)

    async def predictions_1_aspect(
            self,
            call: types.CallbackQuery,
            state: FSMContext
    ):
        await state.update_data(
            one_aspect=call.data
        )
        await call.answer("Выберите ещё один аспект")

        await state.set_state(states.predictions_2_aspect)

    async def predictions_2_aspect(
            self,
            call: types.CallbackQuery,
            state: FSMContext
    ):

        st = await state.get_data()
        period = st["period"]

        one_aspect = st['one_aspect']
        two_aspects = st.get("two_aspect")
        three_aspects = st.get("three_aspect")

        if (one_aspect == call.data or two_aspects == call.data or
                three_aspects == call.data):
            await call.answer(f"Вам нужно выбрать неодинаковые аспекты!!")
            return

        if period == "day":
            if two_aspects:
                if three_aspects:
                    all_aspects = (f"{one_aspect}, {two_aspects}, ",
                                   f"{three_aspects}, {call.data}")
                else:
                    await state.update_data(
                        three_aspect=call.data
                    )
                    await call.answer("Выберите ещё один аспект")
                    return
            else:
                await state.update_data(
                    two_aspect=call.data
                )
                await call.answer("Выберите ещё один аспект")
                return

        col_info = self.operation_db.COLUMNS_INFO

        (place_birth, latitude, longitude, time_birth,
         data_birth) = self.operation_db.select_user_info_db(
            f"{col_info.place_birth}, "
            f"{col_info.latitude}, "
            f"{col_info.longitude}, "
            f"{col_info.time_birth}, "
            f"{col_info.data_birth}",
            call.from_user.id,
            many=True
        )

        if place_birth is None or time_birth is None or data_birth is None:
            text = "Перед началом генерации нужно ввести ваши данные."
            keyboard = self.keyboard.no_generation_data_ikb
            await call.message.edit_text(text=text, reply_markup=keyboard)
            await state.clear()
            return

        await call.message.answer("Ожидайте, примерное время 25-35 секунд ")

        aspects = create_aspects(
            f"{data_birth} {time_birth}",
            latitude,
            longitude
        )

        if period == "day":
            text = self.text["day"].replace("{}", f"{all_aspects}")
        elif period == "month":
            text = self.text["month"].replace("{}", f"{one_aspect} {call.data}")
        else:
            text = self.text["year"].replace("{}", f"{one_aspect} {call.data}")

        text_gpt = await main_get_info_gpt(
            self.config,
            f"{aspects}",
            text
        )
        (count_generation,
         generation_count_all) = self.operation_db.select_user_info_db(
            f"{self.operation_db.COLUMNS_INFO.generation_count}, "
            f"{self.operation_db.COLUMNS_INFO.generation_count_all}",
            call.from_user.id,
            many=True
        )

        self.operation_db.update_user_info_db(
            {
                self.operation_db.COLUMNS_INFO.generation_count: count_generation - 1,
                self.operation_db.COLUMNS_INFO.generation_count_all: generation_count_all + 1,
            },
            call.from_user.id
        )

        if len(str(text_gpt)) > 4096:
            await call.message.answer(str(text_gpt)[:4096])
            await call.message.answer(str(text_gpt)[4096:])
        else:
            await call.message.answer(
                text=str(text_gpt)
            )

        await call.message.answer(
            text=f"Количество оставшихся генераций: {count_generation - 1}",
            reply_markup=self.keyboard.main_menu_kb
        )

        await state.clear()

    def create_router(self):
        self.router.message.register(
            self.main_start_predictions,
            F.text == "🌟 Прогнозы и гороскопы"
        )
        self.router.message.register(
            self.daily_forecasts,
            F.text == "☀️ Ежедневные прогнозы"
        )
        self.router.callback_query.register(
            self.selection_predictions,
            F.data == "start generation",
            StateFilter(AllTypesGeneration.predictions.state)
        )
        self.router.callback_query.register(
            self.get_predictions,
            F.data.split("_")[0] == "select prediction",
            StateFilter(AllTypesGeneration.predictions.state)
        )
        self.router.callback_query.register(
            self.predictions_1_aspect,
            StateFilter(states.predictions_1_aspect)
        )
        self.router.callback_query.register(
            self.predictions_2_aspect,
            StateFilter(states.predictions_2_aspect)
        )
